name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Permite ejecución manual

env:
  PROJECT_ID: check-in-sf
  SERVICE_NAME: jfc-cash-to-pay-audit
  REGION: us-central1
  SERVICE_ACCOUNT: github-actions@check-in-sf.iam.gserviceaccount.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Autenticación con Google Cloud
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Configurar Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configurar Docker para Artifact Registry
      run: |
        echo "Configurando Docker para Artifact Registry..."
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

    - name: Construir imagen Docker
      run: |
        echo "Construyendo imagen Docker..."
        IMAGE_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/cloud-functions/${{ env.SERVICE_NAME }}:${{ github.sha }}"
        echo "Tag de imagen: $IMAGE_TAG"
        docker build -t $IMAGE_TAG .
        docker tag $IMAGE_TAG ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/cloud-functions/${{ env.SERVICE_NAME }}:latest
        echo "Imagen construida exitosamente"

    - name: Subir imagen a Artifact Registry
      run: |
        echo "Subiendo imagen a Artifact Registry..."
        docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/cloud-functions/${{ env.SERVICE_NAME }}:${{ github.sha }} || exit 1
        docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/cloud-functions/${{ env.SERVICE_NAME }}:latest || exit 1
        echo "Imagen subida exitosamente"

    - name: Eliminar función anterior de Cloud Functions (si existe)
      run: |
        echo "Verificando si existe función anterior de Cloud Functions..."
        if gcloud functions describe ${{ env.SERVICE_NAME }} --gen2 --region=${{ env.REGION }} --project=${{ env.PROJECT_ID }} 2>&1; then
          echo "Eliminando función anterior de Cloud Functions..."
          gcloud functions delete ${{ env.SERVICE_NAME }} --gen2 --region=${{ env.REGION }} --project=${{ env.PROJECT_ID }} --quiet || true
        else
          echo "No existe función anterior, continuando..."
        fi

    - name: Desplegar a Cloud Run (Container)
      run: |
        echo "Desplegando a Cloud Run con imagen Docker (Container deployment)..."
        IMAGE_URI="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/cloud-functions/${{ env.SERVICE_NAME }}:${{ github.sha }}"
        echo "URI de imagen: $IMAGE_URI"
        
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image=$IMAGE_URI \
          --region=${{ env.REGION }} \
          --platform=managed \
          --allow-unauthenticated \
          --service-account=${{ env.SERVICE_ACCOUNT }} \
          --memory=256Mi \
          --timeout=60 \
          --max-instances=10 \
          --port=8080 \
          --project=${{ env.PROJECT_ID }} \
          --no-source \
          --quiet

    - name: Obtener URL del servicio
      if: success()
      run: |
        echo "Obteniendo URL del servicio Cloud Run..."
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region=${{ env.REGION }} \
          --format="value(status.url)" \
          --project=${{ env.PROJECT_ID }})
        echo "::notice title=Service URL::El servicio está disponible en: $SERVICE_URL"
        echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
        echo "URL del servicio: $SERVICE_URL"
